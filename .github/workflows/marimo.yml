# Workflow: Marimo
# Purpose: This workflow tests and validates Marimo notebooks to ensure
#          they function correctly and maintain compatibility with the latest dependencies.
#
# Trigger: This workflow runs on pushes to the main branch and pull requests
#
# Components:
#   - ðŸ“š Parse .env file for configuration
#   - ðŸ§ª Test Marimo notebooks execution
name: "Marimo"

on:
  push:
    branches: [main]
  pull_request:

jobs:
  parse-env:
    runs-on: ubuntu-latest
    permissions:
      contents: read
    outputs:
      marimo-folder: ${{ steps.export.outputs.MARIMO_FOLDER }}
    steps:
      - uses: actions/checkout@v4

      - name: Parse .env and export variables
        id: export
        run: |
          set -a
          source .env
          echo "MARIMO_FOLDER=$MARIMO_FOLDER" >> "$GITHUB_OUTPUT"
          set +a
        shell: bash

  test-notebooks:
    runs-on: ubuntu-latest
    needs: parse-env
    permissions:
      contents: read
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.13'

      - name: Install uv
        run: |
          curl -LsSf https://astral.sh/uv/install.sh | sh
          echo "$HOME/.cargo/bin" >> "$GITHUB_PATH"

      - name: Set up virtualenv and install dependencies
        run: |
          uv venv .venv
          source .venv/bin/activate

          if [ -f "pyproject.toml" ]; then
            echo "pyproject.toml found, installing editable package"
            uv pip install -e .
          else
            echo "No pyproject.toml found, skipping package install"
          fi

          uv pip install marimo

      - name: Run Marimo notebooks
        run: |
          source .venv/bin/activate
          NOTEBOOK_DIR="${{ needs.parse-env.outputs.marimo-folder }}"
          echo "Looking for notebooks in $NOTEBOOK_DIR"
          find "$NOTEBOOK_DIR" -name "*.py" | while read -r notebook; do
            echo "Running $notebook"
            marimo run "$notebook" --headless
          done