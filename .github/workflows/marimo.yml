# Workflow: Marimo
# Purpose: This workflow tests and validates Marimo notebooks to ensure
#          they function correctly and maintain compatibility with the latest dependencies.
#
# Trigger: This workflow runs on pushes to the main branch and pull requests
#
# Components:
#   - ðŸ“š Parse .env file for configuration
#   - ðŸ§ª Test Marimo notebooks execution

name: "Marimo"

on:
  push
  #  branches:
  #    - master
  #    - main
  #pull_request:
  #  paths:
  #    - 'book/marimo/**'
  #    - '.github/workflows/marimo.yml'

jobs:
  parse-env:
    runs-on: ubuntu-latest
    permissions:
      contents: read
    outputs:
      marimo-folder: ${{ steps.export.outputs.MARIMO_FOLDER }}
    steps:
      - uses: actions/checkout@v4

      - name: Parse .env and export variables
        id: export
        run: |
          set -a
          source .env
          echo "MARIMO_FOLDER=$MARIMO_FOLDER" >> "$GITHUB_OUTPUT"
          set +a
        shell: bash

  test-notebooks:
    runs-on: ubuntu-latest
    needs: parse-env
    permissions:
      contents: read
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.13'
          
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install marimo
          pip install -e .
          
      - name: Run Marimo notebooks
        run: |
          for notebook in $(find ${{ needs.parse-env.outputs.marimo-folder }} -name "*.py"); do
            echo "Running $notebook"
            marimo run "$notebook" --headless
          done